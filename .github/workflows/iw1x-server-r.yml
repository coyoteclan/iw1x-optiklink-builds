name: iw1x-server-r

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debugging information, disable optimization'
        required: true
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'
      unsafe:
        description: 'Enable unsafe features (fread, fwrite...)'
        required: true
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'

permissions:
  contents: write

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      commit: ${{ steps.get_commit.outputs.commit }}
      branch_exists: ${{ steps.check_branch.outputs.exists }}

    steps:
      - name: Get latest commit of iw1x-server-r
        id: get_commit
        run: |
          COMMIT=$(git ls-remote https://gitlab.com/kazam0180/iw1x-server-r.git HEAD | cut -f1 | cut -c1-7)
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT

      - name: Check if branch already exists
        id: check_branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="iw1x-server-r_${{ steps.get_commit.outputs.commit }}"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/branches/$BRANCH")
          if [ "$STATUS" = "200" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

  build:
    runs-on: ubuntu-latest
    needs: check
    if: needs.check.outputs.branch_exists == 'false'
    container:
      image: debian:buster

    env:
      COMMIT: ${{ needs.check.outputs.commit }}
      DEBUG_BUILD: ${{ inputs.debug || 'false' }}
      BUNSAFE: ${{ inputs.unsafe || 'true' }}

    steps:
      - name: Install Dependencies
        run: |
          rm /etc/apt/sources.list
          echo "deb http://archive.debian.org/debian/ buster main contrib non-free" >> /etc/apt/sources.list
          echo "deb http://archive.debian.org/debian/ buster-updates main contrib non-free" >> /etc/apt/sources.list
          echo "deb http://archive.debian.org/debian-security buster/updates main contrib non-free" >> /etc/apt/sources.list
          echo "deb http://archive.debian.org/debian/ buster-backports main contrib non-free" >> /etc/apt/sources.list
          dpkg --add-architecture i386
          apt update
          apt install -y g++-multilib python3-pip ninja-build pkg-config \
            git bash
          pip3 install meson

      - name: Checkout workflow repo
        uses: actions/checkout@v4

      - name: Clone and build iw1x-server-r
        shell: bash
        run: |
          git clone https://gitlab.com/kazam0180/iw1x-server-r.git --single-branch --depth=1 /tmp/iw1x-server-r

          cp meson_for_r/* /tmp/iw1x-server-r/

          cd /tmp/iw1x-server-r
          source 64bit_build_env
          buildtype='release'
          if [ $DEBUG_BUILD == 'true' ]; then
            buildtype='debug'
          fi
          meson setup build \
            --buildtype $buildtype \
            -Denable_unsafe=$BUNSAFE
          ninja -C build

          rm meson.build meson_options.txt 64bit_build_env

      - name: Commit binary and push branch
        run: |
          git config --global safe.directory '*'
          cd $GITHUB_WORKSPACE
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout --orphan iw1x-server-r_$COMMIT
          git rm -rf .
          find /tmp/iw1x-server-r -mindepth 1 -maxdepth 1 ! -name '.git' ! -name 'build' ! -name '.github' -exec cp -r {} . \;
          cp /tmp/iw1x-server-r/build/iw1x.so ./iw1x.so
          git add .
          git commit -m "Build iw1x-server-r@$COMMIT"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          git push origin iw1x-server-r_$COMMIT

  publish:
    runs-on: ubuntu-latest
    needs: [check, build]
    if: needs.check.outputs.branch_exists == 'false'
    env:
      COMMIT: ${{ needs.check.outputs.commit }}
      BRANCH: iw1x-server-r_${{ needs.check.outputs.commit }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout the new branch
        uses: actions/checkout@v4
        with:
          ref: iw1x-server-r_${{ needs.check.outputs.commit }}

      - name: Create release
        run: |
          cat > notes.md <<EOF
          Automated build of [iw1x-server-r](https://github.com/cod1raph/iw1x-server-r) @ $COMMIT on Debian Buster

          **Build options:**
          - Debug: ${{ inputs.debug }}
          - Unsafe: ${{ inputs.unsafe }}
          EOF
          gh release create "$BRANCH" iw1x.so \
            --title "iw1x-server-r $COMMIT" \
            --notes-file notes.md  \
            --target $BRANCH
